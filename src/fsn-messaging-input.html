<dom-module id="fsn-messaging-input">
  <template>
  <style include="houseme-styles"></style>
  <style>
    :host {
      @apply(--layout-horizontal);
      @apply(--layout-center);

      background: rgba(0,0,0,0.05);
      padding: 8px;
    }

    paper-textarea {
      @apply(--layout-flex);
    }
  </style>

    <paper-textarea maxRows="3" on-keypress='sendMessage' no-label-float value={{message}}></paper-textarea>
    <!-- <iron-icon icon="houseme:send" on-tap='sendMessage'></iron-icon> -->
    <paper-button on-tap='sendMessage'>send</paper-button>

  </template>
</dom-module>

<script>
  require('@polymer/polymer/polymer.html')
  require('@polymer/iron-icon/iron-icon.html')
  require('@polymer/iron-flex-layout/iron-flex-layout.html')
  require('@polymer/paper-input/paper-textarea.html')
  require('@polymer/paper-button/paper-button.html')

  require('moment');

  require('@andreasgalster/fsn-boilerplate/dist/fsn-boilerplate.html')

  Polymer({
    is: 'fsn-messaging-input',
    properties: {
      message: String,
      messageId: String,
      chatId: String
    },

    sendMessage: function(event) {
      let keycode = (event.keyCode ? event.keyCode : event.which);

      if(keycode == '13' || event.type == 'tap'){

        let time = moment().format('ddd D [at] HH:mm');
        let chatId =  Messages.findOne({
          $and: [ {userids: Meteor.userId()}, {userids: this.messageId }]
        });

        console.log(chatId);
        if (chatId) {
          this.chatId = chatId._id;
        }
      // console.log(chatId);

        Meteor.call('sendMessage', this.chatId, this.messageId, this.message, time, () => {
          this.message = '';
        });
        this.fire('fsn-message-sent');
        // Meteor.call('messageRead');
      }
    }

  });
</script>
